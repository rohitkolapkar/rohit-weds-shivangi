<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venue Map | Rohit & Shivangi</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Rozha+One&family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Shared Royal Theme Variables */
            --bg-dark: #0b1d3f;      
            --sidebar-bg: rgba(18, 42, 85, 0.95);
            --gold: #c5a059;         
            --accent-light: #e5c585; 
            --text-main: #fdfbf7;    
            --text-muted: #b8c5d6;
            --border-color: rgba(197, 160, 89, 0.3);
            --ribbon-height: 40px;
            --live-red: #ff4d4d;
        }

        /* --- CRITICAL LAYOUT FIXES --- */
        * { box-sizing: border-box; }
        
        html, body { 
            width: 100%; 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            font-family: 'Lato', sans-serif; 
            background: var(--bg-dark); 
            overflow: hidden;
        }
        
        #map { 
            height: 100%; 
            width: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1; 
            background: #f0f0f0; 
            padding-top: var(--ribbon-height); 
        } 
        
        /* --- 1. INFINITE SCROLLING RIBBON --- */
        .top-ribbon {
            position: fixed; top: 0; left: 0; width: 100%;
            height: var(--ribbon-height);
            background: linear-gradient(90deg, #aa771c, #fbf5b7, #aa771c);
            color: #0b1d3f;
            display: flex; align-items: center; 
            z-index: 4000;
            font-family: 'Cinzel', serif; font-size: 0.85rem; font-weight: 800;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            text-transform: uppercase; letter-spacing: 1px;
            overflow: hidden; 
            white-space: nowrap;
        }

        .marquee-track { display: flex; width: fit-content; animation: infiniteScroll 30s linear infinite; }
        .marquee-content { display: flex; align-items: center; flex-shrink: 0; }
        .marquee-item { margin: 0 30px; display: inline-flex; align-items: center; }
        .ribbon-live-dot { width: 8px; height: 8px; background-color: red; border-radius: 50%; display: inline-block; margin-bottom: 8px; margin-left: 2px; box-shadow: 0 0 5px red; animation: rapidBlink 1s infinite; }
        @keyframes rapidBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes infiniteScroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* --- 2. TITLE BAR --- */
        .map-title-bar {
            position: absolute; top: var(--ribbon-height); left: 0; width: 100%; z-index: 1000;
            background: rgba(11, 29, 63, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px 10px;
            text-align: center; border-bottom: 2px solid var(--gold);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .wedding-title {
            font-family: 'Great Vibes', cursive; 
            font-size: 2.2rem;
            line-height: 1.2;
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite;
            padding-bottom: 5px;
        }
        @keyframes shine { to { background-position: 200% center; } }
        .event-ticker { 
            font-family: 'Cinzel', serif; color: var(--accent-light); 
            font-size: 0.75rem; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- 3. SIDEBAR --- */
        #sidebar {
            position: absolute; top: var(--ribbon-height); right: -420px; width: 400px; 
            height: calc(100% - var(--ribbon-height)); 
            background: var(--sidebar-bg); color: var(--text-main);
            border-left: 1px solid var(--gold);
            box-shadow: -5px 0 30px rgba(0,0,0,0.6); 
            transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); 
            z-index: 2000; overflow-y: auto; padding: 0;
            backdrop-filter: blur(10px);
        }
        #sidebar.open { right: 0; }
        
        .sidebar-header {
            background: rgba(8, 22, 48, 0.95); padding: 20px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 10;
        }
        .sidebar-header h2 { 
            margin: 0; color: var(--gold); font-family: 'Cinzel', serif; 
            font-size: 1.2rem; font-weight: 700; 
        }
        .close-btn { color: var(--accent-light); font-size: 1.5rem; cursor: pointer; padding: 0 10px; transition: color 0.3s;}
        .close-btn:hover { color: #fff; }

        .sidebar-body { padding: 20px; padding-bottom: 90px; }
        .location-meta { margin-bottom: 20px; font-size: 0.9rem; color: var(--text-muted); }
        .meta-item { display: flex; align-items: center; margin-bottom: 10px; }
        .meta-item i { width: 25px; color: var(--gold); }
        
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 25px; }
        .gallery-item {
            width: 100%; height: 100px; object-fit: cover; border-radius: 4px;
            cursor: pointer; transition: transform 0.2s; border: 1px solid var(--border-color);
        }
        .gallery-item:first-child { grid-column: span 2; height: 160px; }
        
        .directions-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 20px; 
            background: linear-gradient(135deg, #c5a059, #8a6d3b); 
            color: #0b1d3f; font-weight: 700; font-size: 14px; text-align: center; 
            border-radius: 2px; text-decoration: none; text-transform: uppercase; letter-spacing: 1px;
            font-family: 'Cinzel', serif;
            box-shadow: 0 4px 15px rgba(197, 160, 89, 0.3);
        }

        /* --- 4. FLOATING VENUE BUTTON --- */
        .recenter-wrapper {
            position: absolute; 
            bottom: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 1000;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .recenter-btn {
            background: var(--live-red); color: #fff; border: 2px solid white; padding: 0;
            border-radius: 50%; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 55px; height: 55px;
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            animation: softPulse 2s infinite;
        }
        
        @keyframes softPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 77, 77, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 77, 77, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(255, 77, 77, 0); }
        }
        
        .recenter-btn:active { transform: scale(0.9); }
        
        .recenter-label {
            margin-top: 5px; font-family: 'Cinzel', serif; font-size: 0.7rem; font-weight: 800;
            color: #000; text-shadow: 0 0 2px #fff; background: rgba(255,255,255,0.9);
            padding: 2px 8px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- 5. FOOTER --- */
        .sticky-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #081630; border-top: 2px solid var(--gold);
            display: flex; justify-content: space-between; padding: 0; z-index: 3000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        .nav-item {
            flex-grow: 1; text-align: center; padding: 12px 0;
            color: var(--text-muted); text-decoration: none; font-size: 0.75rem;
            border-right: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: all 0.2s;
        }
        .nav-item:last-child { border-right: none; }
        .nav-item i { display: block; font-size: 1.2rem; margin-bottom: 4px; color: var(--gold); }
        .nav-item:active { background: #1a3b70; }

        /* --- 6. MAP ELEMENTS --- */
        .map-label div {
            background: rgba(255, 255, 255, 0.9); color: #0b1d3f; 
            border: 1px solid var(--gold);
            padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700;
            position: absolute; top: -12px; white-space: nowrap; pointer-events: auto; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: 'Lato', sans-serif;
        }
        .map-label.collision-hidden { opacity: 0; pointer-events: none; }
        .map-label div { left: 24px; }
        .map-label.force-left div { left: auto; right: 24px; }
        
        /* WEDDING LABEL */
        .map-label.wedding-label div { 
            background: linear-gradient(135deg, #fff, #fdfbf7); 
            color: #d32f2f; 
            border: 2px solid #d32f2f; 
            font-size: 14px; 
            z-index: 500; 
            font-weight: 800;
            font-family: 'Great Vibes', cursive;
            padding: 5px 12px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .wedding-icon { display: flex; align-items: center; justify-content: center; font-size: 14px; color: white; }

        /* --- SCROLLABLE LEGEND (Shifted Down) --- */
        .custom-legend {
            margin-top: 160px !important; 
            background: rgba(255, 255, 255, 0.95); 
            border: 1px solid #ccc; border-radius: 4px; width: 220px; color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            /* Scroll Capability */
            max-height: 50vh; 
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .custom-legend::-webkit-scrollbar { width: 6px; }
        .custom-legend::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 3px; }
        .custom-legend::-webkit-scrollbar-track { background: #f0f0f0; }

        .category-header { padding: 10px; background: #f9f9f9; border-bottom: 1px solid #ddd; display: flex; align-items: center; cursor: pointer;}
        .category-header h4 { margin: 0; font-size: 11px; color: #0b1d3f; flex-grow: 1; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; font-family: 'Cinzel', serif;}
        .legend-list { list-style: none; padding: 0; margin: 0; }
        .legend-item { padding: 8px 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; cursor: pointer; font-size: 12px;}
        .legend-item:hover { background: #f0f0f0; }
        .item-dist { background: #eee; padding: 1px 5px; border-radius: 2px; font-size: 10px; color: #666; }
        .clean-emoji-icon { background: transparent !important; border: none !important; }

        /* --- MOBILE MEDIA QUERY --- */
        @media (max-width: 768px) {
            #sidebar { width: 85%; right: -85%; min-width: 280px; }
            .map-title-bar { padding: 12px 5px; }
            .wedding-title { font-size: 2rem; }
            
            .custom-legend { width: 36px; height: 36px; overflow: hidden; transition: width 0.3s, height 0.3s; }
            .custom-legend:hover { width: 220px; max-height: 60vh; height: auto; overflow-y: auto; }
            .custom-legend::before { content: '\f03a'; font-family: 'FontAwesome'; font-size: 16px; padding: 8px 10px; display: block; color: #555; }
        }
    </style>
</head>
<body>

    <div class="top-ribbon" id="top-ribbon">
        </div>

    <div class="map-title-bar">
        <div class="wedding-title">Rohit & Shivangi</div>
        <div class="event-ticker" id="map-ticker">Loading...</div>
    </div>

    <div id="map"></div>
    
    <div id="sidebar"></div>

    <div class="recenter-wrapper">
        <button class="recenter-btn" onclick="focusVenue()">
            <i class="fa fa-heart"></i>
        </button>
        <span class="recenter-label">VENUE</span>
    </div>

    <div class="sticky-nav">
        <a href="tel:+919421959601" class="nav-item">
            <i class="fas fa-phone"></i> RSVP
        </a>
        <a href="https://www.instagram.com/theroshitales/?hl=en" target="_blank" class="nav-item">
            <i class="fab fa-instagram"></i> theroshitales
        </a>
        <a href="index.html" class="nav-item">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>

    <script>
        // 1. Init Map
        var map = L.map('map', { zoomControl: false }).setView([19.87, 75.30], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap, ¬© CARTO',
            maxZoom: 20
        }).addTo(map);

        const VENUE_COORDS = { lat: 19.839899897787824, lng: 75.27790772699564 };
        const day1 = "2026-02-19"; 
        const day2 = "2026-02-20";
        
        // --- 2. RIBBON LOGIC ---
        function generateMarqueeHTML(text) {
            let set = `<span class="marquee-item">${text}</span>`.repeat(4);
            return `<div class="marquee-track"><div class="marquee-content">${set}</div><div class="marquee-content">${set}</div></div>`;
        }

        function updateMapStatus() {
            const now = new Date();
            const currentDateStr = now.toISOString().split('T')[0];
            const ticker = document.getElementById('map-ticker');
            const ribbon = document.getElementById('top-ribbon');

            // Map Header Ticker
            if (now < new Date(day1)) ticker.innerHTML = "‚è≥ Upcoming Celebration";
            else if (now > new Date(day2 + "T23:59:00")) ticker.innerHTML = "‚ù§Ô∏è Just Married";
            else ticker.innerHTML = "üî¥ Live: Wedding Day!";

            // Ribbon Logic
            let ribbonText = "#TheRoShiSaga <i class='fas fa-heart'></i>"; 
            let isWeddingDay = (currentDateStr === day1 || currentDateStr === day2);
            
            if(isWeddingDay) ribbonText = `LIVE: THE ROYAL WEDDING <i class='fas fa-heart'></i>`;
            else if (now > new Date(day2 + "T23:59:00")) ribbonText = "JUST MARRIED ‚ù§Ô∏è ROHIT & SHIVANGI";

            if (ribbon.getAttribute('data-text') !== ribbonText) {
                ribbon.innerHTML = generateMarqueeHTML(ribbonText);
                ribbon.setAttribute('data-text', ribbonText);
            }
        }

function syncEventStatusFromIndex() {
    const data = sessionStorage.getItem("eventStatus");
    if (!data) return;

    const { state, title } = JSON.parse(data);

    const ticker = document.getElementById("map-ticker");
    const ribbon = document.getElementById("top-ribbon");

    let ribbonText = "#TheRoShiSaga <i class='fas fa-heart'></i>";

    if (state === "LIVE") {
        ticker.innerHTML = `üî¥ Live: ${title}`;
        ribbonText = `LIVE<span class="ribbon-live-dot"></span>: ${title}`;
    }
    else if (state === "NEXT") {
        ticker.innerHTML = `‚è≠Ô∏è Up Next: ${title}`;
        ribbonText = `UP NEXT: ${title}`;
    }
    else {
        ticker.innerHTML = "‚è≥ Upcoming Celebration";
    }

    if (ribbon.getAttribute("data-text") !== ribbonText) {
        ribbon.innerHTML = generateMarqueeHTML(ribbonText);
        ribbon.setAttribute("data-text", ribbonText);
    }
}

        updateMapStatus();
        syncEventStatusFromIndex();

setInterval(() => {
    updateMapStatus();
    syncEventStatusFromIndex();
}, 15000);

        // 3. Full Location Data
        const layers = { venue: new L.LayerGroup(), essential: new L.LayerGroup(), attraction: new L.LayerGroup() };
        const PRIORITIES = { venue: 1, essential: 2, attraction: 3 };
        
        const locations = [
            // VENUE
            { 
                category: 'venue', lat: VENUE_COORDS.lat, lng: VENUE_COORDS.lng, 
                name: "Rugved Celebration Central", icon: 'heart', color: 'red', isAwesome: true, 
                desc: "<strong>The Royal Wedding Venue</strong><br>Dhondre patil landmark, Link road, Golwadi Bypass", 
                images: [
                    "https://cdn0.weddingwire.in/vendor/5014/3_2/960/jpeg/whatsapp-image-2025-01-29-at-2-11-43-pm-1-15-485014-173814043131528_15_485014-173978905460980.jpeg",
                    "https://cdn0.weddingwire.in/vendor/5014/3_2/960/jpeg/whatsapp-image-2025-01-29-at-2-11-45-pm-1-15-485014-173814043083939_15_485014-173978906692960.jpeg",
                    "https://images.unsplash.com/photo-1519741497674-611481863552?auto=format&fit=crop&w=800"
                ] 
            },
            // ESSENTIALS
            { category: 'essential', lat: 19.860591, lng: 75.311265, name: "Aurangabad Railway", icon: 'train', color: 'blue', isAwesome: true, desc: "Main Station", images: ["https://upload.wikimedia.org/wikipedia/commons/thumb/0/00/Aurangabad_railway_station_%286%29.jpg/800px-Aurangabad_railway_station_%286%29.jpg"] },
            { category: 'essential', lat: 19.869168, lng: 75.396549, name: "Airport (IXU)", icon: 'plane', color: 'blue', isAwesome: true, desc: "Airport", images: ["https://images.unsplash.com/photo-1436491865332-7a61a109cc05?auto=format&fit=crop&w=800"] },
            { category: 'essential', lat: 19.881009, lng: 75.317158, name: "Central Bus Stand", icon: 'bus', color: 'green', isAwesome: true, desc: "Main Bus Stand", images: ["https://upload.wikimedia.org/wikipedia/commons/a/a6/Bus_Stand_Aurangabad.jpg"] },
            { category: 'essential', lat: 19.875605, lng: 75.366684, name: "Cidco Bus Stand", icon: 'bus', color: 'green', isAwesome: true, desc: "Secondary bus stand", images: ["https://upload.wikimedia.org/wikipedia/commons/a/a6/Bus_Stand_Aurangabad.jpg"] },
            { category: 'essential', lat: 19.878281, lng: 75.371410, name: "Prozone Mall", icon: 'bag-shopping', color: 'purple', isAwesome: true, desc: "Modern mall", images: ["https://dynamic-media-cdn.tripadvisor.com/media/photo-o/04/10/f9/40/prozone-mall-aurangabad.jpg?w=1200&h=-1&s=1"] },
            { category: 'essential', lat: 19.866189, lng: 75.349653, name: "Reliance Mall", icon: 'bag-shopping', color: 'purple', isAwesome: true, desc: "Shopping complex", images: ["https://content3.jdmagicbox.com/v2/comp/aurangabad-maharashtra/m3/9999px240.x240.240913062432.n3m3/catalogue/reliance-mall-mondha-aurangabad-maharashtra-kXpBm32BKx.jpg"] },
            
            // ATTRACTIONS
            { category: 'attraction', lat: 19.899096, lng: 75.319871, name: "Bibi Ka Maqbara", icon: "üè∞", color: "orange", isAwesome: false, desc: "The 'Taj of the Deccan'", images: ["https://upload.wikimedia.org/wikipedia/commons/7/78/The_Tomb_of_Dilras_Banu_Begum.jpg"] },
            { category: 'attraction', lat: 20.023466, lng: 75.176027, name: "Ellora Caves", icon: "üõï", color: "orange", isAwesome: false, desc: "UNESCO World Heritage site", images: ["https://mymodernmet.com/wp/wp-content/uploads/2019/09/kailasa-temple-ellora-caves-1.jpg"] },
            { category: 'attraction', lat: 19.943674, lng: 75.220549, name: "Daulatabad Fort", icon: "‚õ∞Ô∏è", color: "orange", isAwesome: false, desc: "Historic hill fortress", images: ["https://reclaimtemples.com/wp-content/uploads/2020/09/2018051653-1.jpg"] },
            { category: 'attraction', lat: 20.009924, lng: 75.196080, name: "Bhadra Maruti", icon: "üïâÔ∏è", color: "orange", isAwesome: false, desc: "Reclining Hanuman idol", images: ["https://aurangabadtourism.in/images//tourist-places/bhadra-maruti-temple-aurangabad/bhadra-maruti-temple-aurangabad-india-tourism-history.jpg"] },
            { category: 'attraction', lat: 19.915693, lng: 75.312796, name: "Aurangabad Caves", icon: "üóø", color: "orange", isAwesome: false, desc: "Ancient rock-cut shrines", images: ["https://dynamic-media-cdn.tripadvisor.com/media/photo-o/28/fd/6b/5b/caption.jpg?w=900&h=500&s=1"] },
            { category: 'attraction', lat: 19.879328, lng: 75.317204, name: "Siddharth Garden", icon: "ü¶Å", color: "orange", isAwesome: false, desc: "Popular zoo and garden", images: ["https://aurangabadtourism.in/images//tourist-places/siddharth-garden-and-zoo-aurangabad/siddharth-garden-and-zoo-aurangabad-tourism-entry-ticket-price.jpg"] }
        ];

        // --- Logic ---
        const sidebar = document.getElementById('sidebar');
        let allLabels = [];
        let legendData = { 
            venue: { title: "The Royal Venue", color: "red", items: [] }, 
            essential: { title: "Essentials", color: "blue", items: [] }, 
            attraction: { title: "Nearby Attractions", color: "orange", items: [] } 
        };

        function getDistance(lat, lng) { return (L.latLng(VENUE_COORDS).distanceTo(L.latLng(lat, lng)) / 1000).toFixed(1); }
        
        function createSidebarContent(loc, dist) {
            let mapsUrl = (loc.category === 'venue') ? 
                `https://www.google.com/maps/dir/?api=1&destination=${loc.lat},${loc.lng}` : 
                `https://www.google.com/maps/dir/?api=1&origin=${VENUE_COORDS.lat},${VENUE_COORDS.lng}&destination=${loc.lat},${loc.lng}&travelmode=driving`;
            
            let imgs = loc.images.map(img => `<img src="${img}" class="gallery-item" onclick="window.open('${img}')">`).join('');
            
            return `
                <div class="sidebar-header"><h2>${loc.name}</h2><div class="close-btn" onclick="document.getElementById('sidebar').classList.remove('open')">√ó</div></div>
                <div class="sidebar-body">
                    <div class="location-meta"><div class="meta-item"><i class="fa fa-map-marker-alt"></i> ${dist} km away</div><div class="meta-item"><i class="fa fa-info-circle"></i> ${loc.desc}</div></div>
                    <a href="${mapsUrl}" target="_blank" class="directions-btn">üìç Get Directions</a>
                    <div class="gallery-grid">${imgs}</div>
                </div>`;
        }

        function createIcon(loc) {
            return loc.isAwesome 
                ? L.AwesomeMarkers.icon({ icon: loc.icon, prefix: 'fa', markerColor: loc.color, iconColor: 'white', extraClasses: 'wedding-icon' }) 
                : L.divIcon({ html: `<div style="background:transparent; color:${loc.color}; width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:24px; text-shadow:0 0 2px #fff;">${loc.icon}</div>`, iconSize: [32, 32], className: 'clean-emoji-icon' });
        }

        locations.forEach((loc, i) => {
            let dist = getDistance(loc.lat, loc.lng);
            let sidebarHtml = createSidebarContent(loc, dist);
            let icon = createIcon(loc);
            
            legendData[loc.category].items.push({ name: loc.name, dist: parseFloat(dist), icon: loc.isAwesome ? '<i class="fa fa-'+loc.icon+'" style="color:'+loc.color+'"></i>' : loc.icon, lat: loc.lat, lng: loc.lng, htmlContent: sidebarHtml });

            let marker = L.marker([loc.lat, loc.lng], { icon: icon }).on('click', (e) => { 
                sidebar.innerHTML = sidebarHtml; sidebar.classList.add('open'); map.panTo(e.latlng); L.DomEvent.stopPropagation(e); 
            });

            // Adjust Label Height for Pins
            let anchorY = (loc.category === 'essential') ? 25 : 0;
            let labelClass = loc.category === 'venue' ? 'map-label wedding-label' : 'map-label';
            let labelText = loc.category === 'venue' ? 'Rohit ‚ù§Ô∏è Shivangi' : loc.name;
            
            let labelMarker = L.marker([loc.lat, loc.lng], {
                icon: L.divIcon({ className: labelClass, html: `<div>${labelText}</div>`, iconSize: [null, null], iconAnchor: [0, anchorY] }),
                interactive: true, zIndexOffset: loc.category === 'venue' ? 1000 : 0
            }).on('click', (e) => { sidebar.innerHTML = sidebarHtml; sidebar.classList.add('open'); map.panTo(e.latlng); L.DomEvent.stopPropagation(e); });

            allLabels.push({ marker: labelMarker, priority: PRIORITIES[loc.category], id: i });
            layers[loc.category].addLayer(marker); layers[loc.category].addLayer(labelMarker);
        });

        Object.keys(legendData).forEach(k => legendData[k].items.sort((a,b) => a.dist - b.dist));
        layers.venue.addTo(map); layers.essential.addTo(map); layers.attraction.addTo(map);

        // Simple Collision Detection
        function checkCollisions() {
            let visibleLabels = allLabels.filter(l => map.hasLayer(l.marker));
            visibleLabels.forEach(l => { if(l.marker._icon) { l.marker._icon.classList.remove('collision-hidden'); l.marker._icon.classList.remove('force-left'); } });
            for (let pass = 0; pass < 2; pass++) {
                for (let i = 0; i < visibleLabels.length; i++) {
                    let a = visibleLabels[i]; let iconA = a.marker._icon; if (!iconA || iconA.classList.contains('collision-hidden')) continue; let rectA = iconA.getBoundingClientRect();
                    for (let j = 0; j < visibleLabels.length; j++) {
                        if (i === j) continue; let b = visibleLabels[j]; let iconB = b.marker._icon; if (!iconB || iconB.classList.contains('collision-hidden')) continue; let rectB = iconB.getBoundingClientRect();
                        if (rectA.left < rectB.right && rectA.right > rectB.left && rectA.top < rectB.bottom && rectA.bottom > rectB.top) {
                            if (!iconA.classList.contains('force-left')) iconA.classList.add('force-left');
                            else if (a.priority > b.priority) iconA.classList.add('collision-hidden');
                            else if (a.priority === b.priority && a.id > b.id) iconA.classList.add('collision-hidden');
                        }
                    }
                }
            }
        }
        map.on('moveend zoomend overlayadd overlayremove', checkCollisions);
        setTimeout(checkCollisions, 500);

        // Unified Legend Control
        var UnifiedLegend = L.Control.extend({
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'custom-legend');
                function createSection(key, data) {
                    let section = document.createElement('div'); section.className = 'legend-category';
                    let header = document.createElement('div'); header.className = 'category-header';
                    header.innerHTML = `<input type="checkbox" checked> <h4>${data.title}</h4>`;
                    let list = document.createElement('ul'); list.className = 'legend-list';
                    data.items.forEach(item => {
                        let li = document.createElement('li'); li.className = 'legend-item';
                        li.innerHTML = `<div class="item-left"><span class="item-icon">${item.icon}</span> <span class="item-name">${item.name}</span></div><span class="item-dist">${item.dist}km</span>`;
                        li.onclick = () => { map.flyTo([item.lat, item.lng], 16); };
                        list.appendChild(li);
                    });
                    section.appendChild(header); section.appendChild(list);
                    header.onclick = (e) => { if(e.target.type !== 'checkbox') { let chk = header.querySelector('input'); chk.checked = !chk.checked; chk.dispatchEvent(new Event('change')); } };
                    header.querySelector('input').onchange = function() { this.checked ? (map.addLayer(layers[key]), list.classList.remove('hidden')) : (map.removeLayer(layers[key]), list.classList.add('hidden')); };
                    return section;
                }
                container.appendChild(createSection('venue', legendData.venue));
                container.appendChild(createSection('essential', legendData.essential));
                container.appendChild(createSection('attraction', legendData.attraction));
                L.DomEvent.disableClickPropagation(container); return container;
            }
        });
        map.addControl(new UnifiedLegend({ position: 'topleft' }));

        function focusVenue() { map.flyTo([VENUE_COORDS.lat, VENUE_COORDS.lng], 15, { animate: true, duration: 1.5 }); if (!map.hasLayer(layers.venue)) { map.addLayer(layers.venue); document.querySelector('.custom-legend input').checked = true; } }
        var group = new L.featureGroup([layers.venue, layers.essential, layers.attraction]);
    </script>
</body>
</html>